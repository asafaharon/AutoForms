<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8" />
    <title>Form Submissions - AutoForms</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@2.0.2"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <!-- Navigation -->
    <nav class="bg-white/80 backdrop-blur-lg border-b border-slate-200 sticky top-0 z-50">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center h-16">
            <h1 class="text-xl font-bold text-blue-600">
                <a href="/">AutoForms ✨</a>
            </h1>
            <div class="flex items-center space-x-4">
                <a href="/dashboard" class="text-slate-600 hover:text-blue-600 font-medium">Dashboard</a>
                <a href="/test-generator" class="text-slate-600 hover:text-blue-600 font-medium">Generator</a>
                <span class="text-slate-500">{{ user.username }}</span>
                <a href="/api/auth/logout" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition-all duration-200 text-sm">
                    Logout
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-slate-800 mb-2">📊 Form Submissions</h1>
            <p class="text-slate-600">View and manage submissions from your forms</p>
        </div>

        <!-- Filters and Controls -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
            <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between">
                <div class="flex flex-col sm:flex-row gap-4">
                    <select id="form-filter" class="px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">All Forms</option>
                    </select>
                    
                    <select id="time-filter" class="px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">All Time</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                    </select>
                </div>
                
                <button onclick="refreshSubmissions()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-all duration-200">
                    🔄 Refresh
                </button>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <div class="flex items-center">
                    <div class="p-3 bg-blue-100 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-slate-600">Total Submissions</p>
                        <p id="total-submissions" class="text-2xl font-bold text-slate-900">Loading...</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <div class="flex items-center">
                    <div class="p-3 bg-green-100 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-slate-600">Today</p>
                        <p id="today-submissions" class="text-2xl font-bold text-slate-900">Loading...</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <div class="flex items-center">
                    <div class="p-3 bg-purple-100 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v6a2 2 0 002 2h6a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-slate-600">Active Forms</p>
                        <p id="active-forms" class="text-2xl font-bold text-slate-900">Loading...</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <div class="flex items-center">
                    <div class="p-3 bg-yellow-100 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-slate-600">This Week</p>
                        <p id="week-submissions" class="text-2xl font-bold text-slate-900">Loading...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Submissions Table -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-200">
                <h2 class="text-lg font-semibold text-slate-800">Recent Submissions</h2>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-slate-200">
                    <thead class="bg-slate-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Form</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Submitted</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Summary</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="submissions-table" class="bg-white divide-y divide-slate-200">
                        <!-- Loading state -->
                        <tr>
                            <td colspan="4" class="px-6 py-12 text-center text-slate-500">
                                <div class="animate-pulse">Loading submissions...</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <div id="pagination" class="px-6 py-4 border-t border-slate-200 flex items-center justify-between">
                <div class="text-sm text-slate-600">
                    Showing <span id="showing-range">0-0</span> of <span id="total-count">0</span> submissions
                </div>
                <div class="flex space-x-2">
                    <button id="prev-page" onclick="loadPage(currentPage - 1)" class="px-3 py-1 border border-slate-300 rounded text-sm hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed">
                        Previous
                    </button>
                    <button id="next-page" onclick="loadPage(currentPage + 1)" class="px-3 py-1 border border-slate-300 rounded text-sm hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed">
                        Next
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Submission Detail Modal -->
    <div id="submission-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-slate-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-slate-800">Submission Details</h3>
                    <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
            <div id="modal-content" class="p-6">
                <!-- Modal content will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let selectedFormId = '';
        
        // Load initial data
        document.addEventListener('DOMContentLoaded', function() {
            loadSubmissions();
            loadFormOptions();
            loadStatistics();
        });
        
        async function loadSubmissions(page = 1) {
            currentPage = page;
            
            try {
                const params = new URLSearchParams({
                    page: page,
                    limit: 20
                });
                
                if (selectedFormId) {
                    params.append('form_id', selectedFormId);
                }
                
                const response = await fetch(`/api/submissions/user/all?${params}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    renderSubmissions(data.submissions);
                    updatePagination(data);
                } else {
                    throw new Error(data.detail || 'Failed to load submissions');
                }
                
            } catch (error) {
                console.error('Error loading submissions:', error);
                document.getElementById('submissions-table').innerHTML = `
                    <tr>
                        <td colspan="4" class="px-6 py-12 text-center text-red-500">
                            Error loading submissions: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }
        
        function renderSubmissions(submissions) {
            const tbody = document.getElementById('submissions-table');
            
            if (submissions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="px-6 py-12 text-center text-slate-500">
                            No submissions found. Create a form and share it to start collecting submissions!
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = submissions.map(submission => {
                const submittedDate = new Date(submission.submitted_at).toLocaleString();
                
                // Create a user-friendly summary of the submitted data
                const dataEntries = Object.entries(submission.data);
                let summary = '';
                if (dataEntries.length > 0) {
                    const firstEntry = dataEntries[0];
                    const firstName = firstEntry[0].replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    const firstValue = String(firstEntry[1]).substring(0, 40);
                    summary = `${firstName}: ${firstValue}`;
                    if (dataEntries.length > 1) {
                        summary += ` (+${dataEntries.length - 1} more field${dataEntries.length > 2 ? 's' : ''})`;
                    }
                } else {
                    summary = 'No data';
                }
                
                return `
                    <tr class="hover:bg-slate-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-slate-900">${submission.form_title}</div>
                            <div class="text-sm text-slate-500">${new Date(submission.submitted_at).toLocaleDateString()}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900">
                            ${submittedDate}
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-slate-600 max-w-xs">
                                ${summary}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="viewSubmission('${submission.id}')" class="bg-blue-100 hover:bg-blue-200 text-blue-800 px-3 py-1 rounded-lg text-xs font-semibold mr-2 transition-colors">
                                👁️ View Details
                            </button>
                            <button onclick="deleteSubmission('${submission.id}')" class="bg-red-100 hover:bg-red-200 text-red-800 px-3 py-1 rounded-lg text-xs font-semibold transition-colors">
                                🗑️ Delete
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function updatePagination(data) {
            const start = (data.page - 1) * data.limit + 1;
            const end = Math.min(data.page * data.limit, data.total_count);
            
            document.getElementById('showing-range').textContent = `${start}-${end}`;
            document.getElementById('total-count').textContent = data.total_count;
            
            document.getElementById('prev-page').disabled = data.page <= 1;
            document.getElementById('next-page').disabled = !data.has_more;
        }
        
        async function viewSubmission(submissionId) {
            try {
                const response = await fetch(`/api/submissions/details/${submissionId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                const submission = await response.json();
                
                if (response.ok) {
                    showSubmissionModal(submission);
                } else {
                    alert('Error loading submission details');
                }
                
            } catch (error) {
                console.error('Error loading submission:', error);
                alert('Error loading submission details');
            }
        }
        
        function showSubmissionModal(submission) {
            const modalContent = document.getElementById('modal-content');
            
            const dataRows = Object.entries(submission.data).map(([key, value]) => `
                <tr>
                    <td class="px-4 py-2 font-medium text-slate-600 border-b">${key.replace('_', ' ')}</td>
                    <td class="px-4 py-2 text-slate-900 border-b">${value}</td>
                </tr>
            `).join('');
            
            modalContent.innerHTML = `
                <div class="space-y-6">
                    <div>
                        <h4 class="font-semibold text-slate-800 mb-2">Form Information</h4>
                        <p><strong>Form:</strong> ${submission.form_title}</p>
                        <p><strong>Submitted:</strong> ${new Date(submission.submitted_at).toLocaleString()}</p>
                        <p><strong>Submission ID:</strong> ${submission.id}</p>
                    </div>
                    
                    <div>
                        <h4 class="font-semibold text-slate-800 mb-2">Form Data</h4>
                        <div class="overflow-x-auto">
                            <table class="min-w-full">
                                ${dataRows}
                            </table>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="font-semibold text-slate-800 mb-2">Technical Details</h4>
                        <p><strong>IP Address:</strong> ${submission.ip_address || 'Unknown'}</p>
                        <p><strong>User Agent:</strong> ${submission.user_agent || 'Unknown'}</p>
                        <p><strong>Referrer:</strong> ${submission.referrer || 'Direct'}</p>
                    </div>
                </div>
            `;
            
            document.getElementById('submission-modal').classList.remove('hidden');
            document.getElementById('submission-modal').classList.add('flex');
        }
        
        function closeModal() {
            document.getElementById('submission-modal').classList.add('hidden');
            document.getElementById('submission-modal').classList.remove('flex');
        }
        
        async function deleteSubmission(submissionId) {
            if (!confirm('Are you sure you want to delete this submission?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/submissions/${submissionId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    loadSubmissions(currentPage);
                    loadStatistics();
                } else {
                    alert('Error deleting submission');
                }
                
            } catch (error) {
                console.error('Error deleting submission:', error);
                alert('Error deleting submission');
            }
        }
        
        function loadPage(page) {
            if (page < 1) return;
            loadSubmissions(page);
        }
        
        function refreshSubmissions() {
            loadSubmissions(currentPage);
            loadStatistics();
        }
        
        async function loadFormOptions() {
            // This would load user's forms for the filter dropdown
            // Implementation depends on your forms API
        }
        
        async function loadStatistics() {
            try {
                // Get all submissions to calculate statistics
                const response = await fetch('/api/submissions/user/all?page=1&limit=1000', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load statistics');
                }
                
                const data = await response.json();
                const submissions = data.submissions || [];
                
                // Calculate statistics
                const totalSubmissions = data.total_count || 0;
                
                // Get today's date in user's timezone
                const today = new Date();
                const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                
                // Get week start (Monday)
                const weekStart = new Date(today);
                weekStart.setDate(today.getDate() - ((today.getDay() + 6) % 7));
                weekStart.setHours(0, 0, 0, 0);
                
                // Count submissions by date
                let todayCount = 0;
                let weekCount = 0;
                const formIds = new Set();
                
                submissions.forEach(submission => {
                    const submissionDate = new Date(submission.submitted_at);
                    formIds.add(submission.form_id);
                    
                    if (submissionDate >= todayStart) {
                        todayCount++;
                    }
                    if (submissionDate >= weekStart) {
                        weekCount++;
                    }
                });
                
                // Update the dashboard
                document.getElementById('total-submissions').textContent = totalSubmissions.toLocaleString();
                document.getElementById('today-submissions').textContent = todayCount.toLocaleString();
                document.getElementById('active-forms').textContent = formIds.size.toLocaleString();
                document.getElementById('week-submissions').textContent = weekCount.toLocaleString();
                
            } catch (error) {
                console.error('Error loading statistics:', error);
                // Show error state
                document.getElementById('total-submissions').textContent = '?';
                document.getElementById('today-submissions').textContent = '?';
                document.getElementById('active-forms').textContent = '?';
                document.getElementById('week-submissions').textContent = '?';
            }
        }
    </script>

</body>
</html>